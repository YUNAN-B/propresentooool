<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monaco Editor in Website</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: sans-serif;
    }
    #controls {
      padding: 10px;
      background-color: #f0f0f0;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #controls button {
      padding: 8px 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #e0e0e0;
      cursor: pointer;
      font-size: 14px;
    }
    #controls a {
      padding: 8px 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #e0e0e0;
      cursor: pointer;
      font-size: 14px;
      color: #000;
      text-decoration:none
    }
    #controls button:hover {
      background-color: #d0d0d0;
    }
    #editor {
      width: 100%;
      flex-grow: 1;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
      animation-name: animatetop;
      animation-duration: 0.4s;
      border-radius: 8px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }
    .close-button {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    .settings-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .settings-item label {
      min-width: 60px;
    }
    .settings-item input[type="text"] {
      flex-grow: 1;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .settings-item input[type="color"] {
      width: 40px;
      height: 30px;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    .settings-actions {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 20px;
    }
    .settings-actions button {
      padding: 8px 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .settings-actions button:hover {
      background-color: #45a049;
    }

    @-webkit-keyframes animatetop {
      from {top: -300px; opacity: 0}
      to {top: 0; opacity: 1}
    }
    @keyframes animatetop {
      from {top: -300px; opacity: 0}
      to {top: 0; opacity: 1}
    }

    .monaco-editor .token.lyric-tag-custom {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button id="settingsButton">設定標籤顏色</button>
    <button id="copyButton">複製內容</button>
    <a href="https://yunan-b.github.io/propresentooool/">回家</a>
  </div>
  <div id="editor"></div>
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>標籤顏色設定</h2>
        <span class="close-button">&times;</span>
      </div>
      <div id="settingsList"></div>
      <div class="settings-actions">
        <button id="resetDefaultsButton">回復預設</button>
        <button id="addRowButton">新增規則</button>
        <button id="saveSettingsButton">儲存變更</button>
      </div>
    </div>
  </div>

  <!-- 從 CDN 載入 Monaco Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.min.js"></script>
  <script>
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      const defaultSettings = [
        { pattern: '([Vv]erse)? ?1\\.?', color: '#0000E3' },
        { pattern: '([Vv]erse)? ?2\\.?', color: '#00DB00' },
        { pattern: '([Vv]erse)? ?3\\.?', color: '#FF5809' },
        { pattern: '[Cc]horus', color: '#FF0000' },
        { pattern: '[Bb]ridge', color: '#AE00AE' }
      ];

      let editor = null;

      function loadSettings() {
        try {
          const storedSettings = localStorage.getItem('lyricHighlightSettings');
          return storedSettings ? JSON.parse(storedSettings) : defaultSettings;
        } catch (e) {
          console.error("Error loading settings from localStorage:", e);
          return defaultSettings;
        }
      }

      function saveSettings(settings) {
        try {
          localStorage.setItem('lyricHighlightSettings', JSON.stringify(settings));
          return true;
        } catch (e) {
          console.error("Error saving settings to localStorage:", e);
          alert('儲存失敗，可能是 localStorage 已滿！');
          return false;
        }
      }

      function applyEditorSettings(currentSettings) {
        if (!monaco) return;

        const rules = [];
        const cssRules = [];
        const validSettings = currentSettings.filter(setting => {
          try {
            new RegExp(setting.pattern);
            return true;
          } catch (e) {
            console.warn(`Invalid regex pattern "${setting.pattern}":`, e);
            return false;
          }
        });

        validSettings.forEach((setting, index) => {
          const regex = new RegExp(setting.pattern, 'g');
          rules.push([regex, `lyric-tag-custom-${index}`]);
          cssRules.push(`.monaco-editor .token.lyric-tag-custom-${index} { color: ${setting.color} !important; }`);
        });

        let styleTag = document.getElementById('monaco-custom-styles');
        if (!styleTag) {
          styleTag = document.createElement('style');
          styleTag.id = 'monaco-custom-styles';
          document.head.appendChild(styleTag);
        }
        styleTag.innerHTML = cssRules.join('\n');

        monaco.languages.register({ id: 'lyrics' });

        monaco.languages.setMonarchTokensProvider('lyrics', {
          tokenizer: {
            root: [
              ...rules,
              [/./, ''],
            ]
          }
        });

        monaco.editor.defineTheme('lyrics-custom-theme', {
          base: 'vs',
          inherit: true,
          rules: validSettings.map((setting, index) => ({
            token: `lyric-tag-custom-${index}`,
            foreground: setting.color.substring(1)
          })),
          colors: {}
        });

        if (editor) {
          monaco.editor.setModelLanguage(editor.getModel(), 'lyrics');
          monaco.editor.setTheme('lyrics-custom-theme');
        }
      }

      function renderSettingsUI(settings) {
        const settingsList = document.getElementById('settingsList');
        const fragment = document.createDocumentFragment();
        settingsList.innerHTML = '';

        settings.forEach((setting, index) => {
          const div = document.createElement('div');
          div.className = 'settings-item';
          const rowId = `setting-row-${Date.now()}-${index}`;
          div.id = rowId;

          div.innerHTML = `
            <label for="pattern-${rowId}">文字 (正規表達式):</label>
            <input type="text" id="pattern-${rowId}" value="${escapeHtml(setting.pattern)}" placeholder="例如: \\\\\[Verse\\s+\\d+\\\\\]">
            <label for="color-${rowId}">顏色:</label>
            <input type="color" id="color-${rowId}" value="${escapeHtml(setting.color)}">
            <button class="remove-row-button" data-row-id="${rowId}">移除</button>
          `;

          div.querySelector('.remove-row-button').addEventListener('click', function() {
            removeSettingRow(this.dataset.rowId);
          });

          fragment.appendChild(div);
        });

        settingsList.appendChild(fragment);
      }

      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
      }

      function addSettingRow() {
        const settingsList = document.getElementById('settingsList');
        const newRowId = `setting-row-${Date.now()}-${settingsList.children.length}`;
        const div = document.createElement('div');
        div.className = 'settings-item';
        div.id = newRowId;

        div.innerHTML = `
          <label for="pattern-${newRowId}">文字 (正規表達式):</label>
          <input type="text" id="pattern-${newRowId}" value="" placeholder="例如: \\\\\[Verse\\s+\\d+\\\\\]">
          <label for="color-${newRowId}">顏色:</label>
          <input type="color" id="color-${newRowId}" value="#000000">
          <button class="remove-row-button" data-row-id="${newRowId}">移除</button>
        `;

        div.querySelector('.remove-row-button').addEventListener('click', function() {
          removeSettingRow(this.dataset.rowId);
        });

        settingsList.appendChild(div);
      }

      function removeSettingRow(rowIdToRemove) {
        const settingsList = document.getElementById('settingsList');
        const rowToRemove = document.getElementById(rowIdToRemove);
        if (rowToRemove) {
          rowToRemove.remove();
        }

        const currentSettings = [];
        Array.from(settingsList.children).forEach(item => {
          const patternInput = item.querySelector('input[type="text"]');
          const colorInput = item.querySelector('input[type="color"]');
          if (patternInput && colorInput) {
            currentSettings.push({
              pattern: patternInput.value,
              color: colorInput.value
            });
          }
        });
        saveSettings(currentSettings);
        applyEditorSettings(currentSettings);
      }

      const initialSettings = loadSettings();

      editor = monaco.editor.create(document.getElementById('editor'), {
        value: `1.
2.
Verse 1
Verse2
Verse 3`,
        language: 'lyrics',
        theme: 'lyrics-custom-theme',
        automaticLayout: true
      });

      applyEditorSettings(initialSettings);

      const settingsModal = document.getElementById('settingsModal');
      const settingsButton = document.getElementById('settingsButton');
      const closeButton = document.querySelector('.close-button');
      const saveSettingsButton = document.getElementById('saveSettingsButton');
      const addRowButton = document.getElementById('addRowButton');
      const resetDefaultsButton = document.getElementById('resetDefaultsButton');

      settingsButton.onclick = function() {
        settingsModal.style.display = 'flex';
        renderSettingsUI(loadSettings());
      }

      closeButton.onclick = function() {
        settingsModal.style.display = 'none';
      }

      window.onclick = function(event) {
        if (event.target == settingsModal) {
          settingsModal.style.display = 'none';
        }
      }

      addRowButton.onclick = addSettingRow;

      resetDefaultsButton.onclick = function() {
        saveSettings(defaultSettings);
        applyEditorSettings(defaultSettings);
        renderSettingsUI(defaultSettings);
        alert('已回復至預設設定！');
      };

      saveSettingsButton.onclick = function() {
        const settingsList = document.getElementById('settingsList');
        const newSettings = [];
        Array.from(settingsList.children).forEach(item => {
          const patternInput = item.querySelector('input[type="text"]');
          const colorInput = item.querySelector('input[type="color"]');
          if (patternInput && colorInput) {
            try {
              new RegExp(patternInput.value);
              newSettings.push({
                pattern: patternInput.value,
                color: colorInput.value
              });
            } catch (e) {
              alert(`無效的正規表達式: ${patternInput.value}`);
            }
          }
        });
        saveSettings(newSettings);
        applyEditorSettings(newSettings);
        settingsModal.style.display = 'none';
        alert('設定已儲存並套用！');
      };

      document.getElementById('copyButton').addEventListener('click', function() {
        const lyrics = editor.getValue();
        navigator.clipboard.writeText(lyrics).then(function() {
          alert('已將內容複製到剪貼簿！');
        }, function(err) {
          console.error('無法複製:', err);
          alert('複製失敗，請手動複製。');
        });
      });
    });
  </script>
</body>
</html>
